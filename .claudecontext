# AnimaLineage - Application de Gestion d'Ã‰levage

## Vue d'ensemble
Application web full-stack moderne pour la gestion professionnelle d'Ã©levages avec interface React/TypeScript et API PHP robuste.

## Architecture
```
AnimaLineage/
â”œâ”€â”€ frontend/           # Application React TypeScript (port 3002)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/ # Composants React modulaires
â”‚   â”‚   â”‚   â”œâ”€â”€ Auth.tsx              # Authentification
â”‚   â”‚   â”‚   â”œâ”€â”€ MainDashboard.tsx     # Tableau de bord principal
â”‚   â”‚   â”‚   â”œâ”€â”€ AdminPanel.tsx        # Interface d'administration
â”‚   â”‚   â”‚   â”œâ”€â”€ ElevageForm.tsx       # Gestion des Ã©levages
â”‚   â”‚   â”‚   â”œâ”€â”€ AnimalForm.tsx        # Gestion des animaux (ğŸ¦•)
â”‚   â”‚   â”‚   â”œâ”€â”€ AnimalList.tsx        # Liste des animaux (ğŸ¦•)
â”‚   â”‚   â”‚   â”œâ”€â”€ RaceForm.tsx          # Gestion des races
â”‚   â”‚   â”‚   â”œâ”€â”€ TypeAnimalForm.tsx    # Types d'animaux (ğŸ¦•)
â”‚   â”‚   â”‚   â”œâ”€â”€ TransferRequestManager.tsx # Gestion demandes transfert
â”‚   â”‚   â”‚   â”œâ”€â”€ LanguageSelector.tsx  # SÃ©lecteur de langue (i18n)
â”‚   â”‚   â”‚   â”œâ”€â”€ ElevageUsersManagement.tsx # Gestion utilisateurs Ã©levage
â”‚   â”‚   â”‚   â””â”€â”€ CompatibilityTester.tsx    # Testeur compatibilitÃ© reproduction
â”‚   â”‚   â”œâ”€â”€ contexts/   # Gestion d'Ã©tat global
â”‚   â”‚   â”‚   â””â”€â”€ AuthContext.tsx       # Contexte d'authentification
â”‚   â”‚   â”œâ”€â”€ i18n/       # Internationalisation
â”‚   â”‚   â”œâ”€â”€ store/      # Store Redux
â”‚   â”‚   â”œâ”€â”€ hooks/      # Hooks personnalisÃ©s
â”‚   â”‚   â””â”€â”€ utils/      # Fonctions utilitaires
â”‚   â”‚       â”œâ”€â”€ auth.ts               # Utilitaires d'authentification
â”‚   â”‚       â”œâ”€â”€ errorHandler.ts       # Gestion d'erreurs
â”‚   â”‚       â””â”€â”€ errorCodes.ts         # Codes d'erreur
â”‚   â”œâ”€â”€ package.json    # DÃ©pendances Node.js
â”‚   â””â”€â”€ build/          # Build de production
â”œâ”€â”€ backend/            # API REST PHP (port 3001)
â”‚   â”œâ”€â”€ controllers/    # ContrÃ´leurs MVC
â”‚   â”‚   â”œâ”€â”€ UserController.php        # Gestion utilisateurs
â”‚   â”‚   â”œâ”€â”€ AuthController.php        # Authentification
â”‚   â”‚   â”œâ”€â”€ AdminController.php       # Administration
â”‚   â”‚   â”œâ”€â”€ SimpleAdminController.php # Administration simplifiÃ©e
â”‚   â”‚   â”œâ”€â”€ ElevageController.php     # Gestion Ã©levages
â”‚   â”‚   â”œâ”€â”€ AnimalController.php      # Gestion animaux
â”‚   â”‚   â””â”€â”€ TransferRequestController.php # Demandes de transfert
â”‚   â”œâ”€â”€ models/         # ModÃ¨les de donnÃ©es
â”‚   â”‚   â”œâ”€â”€ User.php                  # ModÃ¨le utilisateur
â”‚   â”‚   â”œâ”€â”€ Animal.php                # ModÃ¨le animal
â”‚   â”‚   â”œâ”€â”€ Elevage.php               # ModÃ¨le Ã©levage
â”‚   â”‚   â”œâ”€â”€ Race.php                  # ModÃ¨le race
â”‚   â”‚   â”œâ”€â”€ TypeAnimal.php            # ModÃ¨le type animal
â”‚   â”‚   â””â”€â”€ TransferRequest.php       # ModÃ¨le demande de transfert
â”‚   â”œâ”€â”€ config/         # Configuration systÃ¨me
â”‚   â”‚   â”œâ”€â”€ database.php              # Configuration BDD
â”‚   â”‚   â””â”€â”€ env.php                   # Variables d'environnement
â”‚   â”œâ”€â”€ migrations/     # Migrations de schÃ©ma
â”‚   â”œâ”€â”€ middleware/     # Middleware sÃ©curitÃ©
â”‚   â”‚   â””â”€â”€ AuthMiddleware.php        # Authentification JWT
â”‚   â”œâ”€â”€ database/       # Base de donnÃ©es SQLite
â”‚   â””â”€â”€ index.php       # Point d'entrÃ©e et routeur API
â”œâ”€â”€ docs/               # Documentation projet
â”‚   â”œâ”€â”€ ARCHITECTURE.md               # Architecture systÃ¨me
â”‚   â””â”€â”€ CONVENTIONS.md                # Conventions de code
â”œâ”€â”€ scripts/            # Scripts utilitaires
â””â”€â”€ .nvmrc              # Version Node.js recommandÃ©e
```

## SÃ©curitÃ©
La sÃ©curitÃ© est la prioritÃ© de tout dÃ©veloppement.
Les actions transmises par le frontend doivent Ãªtre vÃ©rifiÃ©es par le backend pour se prÃ©munir d'une tentative de piratage et/ou de corruption de donnÃ©es et/ou d'escalade de droits.

## Stack Technique

### Frontend (React/TypeScript)
- **React 19.1.1** avec TypeScript 4.9.5
- **React Testing Library** pour les tests unitaires
- **Tailwind CSS v3.4.0** avec PostCSS pour le styling modulaire
- **Context API** pour la gestion d'Ã©tat global
- **Fetch API** pour les appels HTTP
- **ESLint & Prettier** pour la qualitÃ© du code
- **Redux toolkit** pour gÃ©rer les Ã©tats avec React de maniÃ¨re standardisÃ©e
- **react-i18next** pour l'internationalisation
- **PostCSS** avec Autoprefixer pour la gestion des styles CSS

### Backend (PHP)
- **PHP 7.4+** avec architecture MVC orientÃ©e objet
- **PDO** pour l'abstraction base de donnÃ©es
- **JWT (firebase/php-jwt)** pour l'authentification stateless
- **Architecture REST** pour l'API
- **Support multi-SGBD** (SQLite/MySQL/PostgreSQL)
- **Migrations automatiques** pour le schÃ©ma de donnÃ©es

## ModÃ¨les de DonnÃ©es

### EntitÃ©s principales
- **User** : Utilisateurs avec systÃ¨me de validation par statut
  - Statuts : `0` (en attente), `1` (validÃ©), `2` (rejetÃ©)
  - RÃ´les : administrateur, Ã©leveur, consultant
  - Authentification JWT sÃ©curisÃ©e

- **Elevage** : Structures d'Ã©levage
  - Informations complÃ¨tes (nom, adresse, contact)
  - Liaison avec utilisateurs propriÃ©taires
  - Gestion multi-Ã©levage par utilisateur

- **Animal** : Animaux individuels
  - DonnÃ©es complÃ¨tes (identification, gÃ©nÃ©alogie)
  - Liaison avec Ã©levage et race
  - Historique et suivi sanitaire

- **Race** : Races d'animaux
  - Classification par type d'animal
  - CaractÃ©ristiques spÃ©cifiques

- **TypeAnimal** : Types d'animaux
  - CatÃ©gories principales (bovins, ovins, etc.)
  - Structuration hiÃ©rarchique

## FonctionnalitÃ©s Principales

### Authentification & Autorisation
- **SystÃ¨me JWT** avec tokens sÃ©curisÃ©s
- **Middleware d'authentification** sur toutes les routes protÃ©gÃ©es
- **Gestion des rÃ´les** avec contrÃ´le d'accÃ¨s granulaire
- **Comptes en attente** avec systÃ¨me de validation administrateur

### Gestion d'Ã‰levage
- **CRUD complet** pour Ã©levages, animaux, races et types
- **Interface intuitive** avec formulaires validÃ©s (ğŸ¦• Ã©mojis cohÃ©rents)
- **Recherche et filtrage** avancÃ©s
- **Tableau de bord** avec vue d'ensemble
- **Gestion des demandes de transfert** d'animaux entre Ã©levages
- **SÃ©lection intelligente des parents** (mÃªme espÃ¨ce uniquement)
- **Filtrage automatique** des utilisateurs validÃ©s uniquement
- **Filtrage correct par Ã©levage** (correction v2.1.1 - admins voient uniquement les animaux de l'Ã©levage consultÃ©)
- **Gestion des utilisateurs d'Ã©levage** : SystÃ¨me complet d'ajout/suppression avec permissions
- **Testeur de compatibilitÃ©** : Module avancÃ© d'analyse de reproduction avec scoring gÃ©nÃ©tique

### Administration
- **Panel d'administration** pour la gestion des utilisateurs
- **Validation des comptes** en attente
- **Gestion des permissions** et rÃ´les
- **Monitoring** des activitÃ©s
- **ContrÃ´les d'accÃ¨s granulaires** :
  - Types & Races : Admin uniquement (rÃ´le 1)
  - Animaux & Transferts : Admin et ModÃ©rateurs (rÃ´le â‰¤ 2)
  - Ã‰levages : Tous les utilisateurs validÃ©s
  - CompatibilitÃ© Reproduction : Tous les utilisateurs validÃ©s (sans contrainte d'Ã©levage)
  - Gestion utilisateurs Ã©levage : Admin (tous Ã©levages) et ModÃ©rateurs (leurs Ã©levages)

### SÃ©curitÃ© & Performance
- **Validation cÃ´tÃ© client et serveur**
- **Ã‰chappement des donnÃ©es** avec requÃªtes prÃ©parÃ©es
- **Interface responsive** pour tous les appareils
- **Gestion d'erreurs** robuste

## Configuration

### DÃ©veloppement
- Backend: `php -S 0.0.0.0:3001 index.php` dans /backend (important: 0.0.0.0 pour Ã©viter les erreurs de connexion)
- Frontend: `npm start` dans /frontend (dÃ©marre sur port 3002)
- Base de donnÃ©es: SQLite automatique (backend/database.sqlite)
- Logo: IntÃ©grÃ© dans MainDashboard (/logo_full.svg)

### Production
- Variables d'environnement dans backend/.env
- Support MySQL/PostgreSQL
- Build frontend avec `npm run build`

## Scripts disponibles
- Frontend: start, build, test, eject
- Backend: migrate.php pour les migrations

## SÃ©curitÃ©
- Authentification JWT
- Validation des entrÃ©es
- CORS configurÃ©
- Middleware d'autorisation

## RÃ©centes AmÃ©liorations (2025-10-01)

### Nouvelles fonctionnalitÃ©s
- âœ… **Validation des dates** : Ajout de validation et limites dans les formulaires d'animaux
- âœ… **Statistiques d'Ã©levage** : Nouveau module de statistiques avec pyramide des Ã¢ges dans ElevageDetail
- âœ… **Colonnes triables** : Table des animaux avec tri par colonnes dans ElevageDetail
- âœ… **Support contexte Ã©levage** : IntÃ©gration du contexte d'Ã©levage dans AnimalForm

### AmÃ©liorations CI/CD
- âœ… **Workflow simplifiÃ©** : Tests focalisÃ©s sur les bases essentielles
- âœ… **Tests backend PHP** : Ajout des tests PHP avec structure amÃ©liorÃ©e
- âœ… **Matrice Node.js** : Support Node.js 18 dans la CI
- âœ… **Nettoyage CI** : Suppression uploads Codecov et optimisation workflow

## AmÃ©liorations PrÃ©cÃ©dentes (2025-09-22)

### Interface Utilisateur
- âœ… **Migration vers Tailwind CSS** : Refactoring complet des styles des composants animaux
- âœ… **Logo intÃ©grÃ©** : Remplacement du titre h1 par le logo SVG dans MainDashboard
- âœ… **Harmonisation du thÃ¨me sombre** : Uniformisation des couleurs (#282c34, #374151, #1f2937)
- âœ… **Formulaires amÃ©liorÃ©s** : SÃ©lection propriÃ©taire fonctionnelle dans ElevageForm
- âœ… **AmÃ©lioration des boutons** : Renommage des boutons dans l'onglet Ã©levages pour plus de clartÃ©
  - "Action" â†’ "Configuration" pour l'Ã©dition d'Ã©levage
  - "Animaux" â†’ "Ã‰dition" pour la gestion des animaux et utilisateurs
- âœ… **Harmonisation visuelle** : Styles des boutons alignÃ©s avec l'onglet "Types & Races"
- âœ… **Optimisation CSS** : Suppression des redondances avec Tailwind CSS et PostCSS
- âœ… **Ã‰mojis cohÃ©rents** : Ajout de l'Ã©moji ğŸ¦• dans toutes les interfaces liÃ©es aux animaux

### SÃ©curitÃ© & AccÃ¨s
- âœ… **Restriction Types & Races** : AccÃ¨s Admin uniquement (frontend + backend)
- âœ… **Filtrage utilisateurs validÃ©s** : Seuls les utilisateurs status=1 disponibles dans les formulaires
- âœ… **Correction authentification** : Migration localStorage â†’ sessionStorage pour cohÃ©rence
- âœ… **Validation parentale** : SÃ©lection parents limitÃ©e Ã  la mÃªme espÃ¨ce (type d'animal)

### FonctionnalitÃ©s MÃ©tier
- âœ… **Gestion demandes de transfert** : Nouveau systÃ¨me complet (TransferRequestController)
- âœ… **SÃ©lection intelligente parents** : Filtre automatique par type d'animal (Ovin, Bovin, etc.)
- âœ… **Gestion multi-langues** : Infrastructure i18n avec LanguageSelector
- âœ… **Store Redux** : Architecture d'Ã©tat centralisÃ©e mise en place
- âœ… **Gestion utilisateurs Ã©levage** : Ajout/suppression d'utilisateurs avec contrÃ´les de permissions
- âœ… **Testeur de compatibilitÃ©** : Nouveau module de test de compatibilitÃ© de reproduction
  - Analyse de la diversitÃ© gÃ©nÃ©tique avec scoring intelligent
  - DÃ©tection automatique de consanguinitÃ© (parent-enfant, frÃ¨res/sÅ“urs)
  - VÃ©rification de compatibilitÃ© d'espÃ¨ce et de sexe
  - Accessible Ã  tous les utilisateurs sans contrainte d'Ã©levage

### Corrections Techniques
- âœ… **UserController** : Correction accÃ¨s propriÃ©tÃ© database privÃ©e
- âœ… **Boucles infinies** : Optimisation dÃ©pendances useCallback dans AnimalForm
- âœ… **Serveur PHP** : Configuration 0.0.0.0:3001 pour Ã©viter erreurs connexion
- âœ… **Tests unitaires** : Infrastructure de tests complÃ¨te (React Testing Library)
- âœ… **Filtrage animaux** : Correction du filtrage par Ã©levage pour les administrateurs
- âœ… **Scoring consanguinitÃ©** : Correction du calcul de diversitÃ© gÃ©nÃ©tique pour les animaux apparentÃ©s
- âœ… **Affichage espÃ¨ces** : Correction de "undefined" dans l'affichage des espÃ¨ces

## Ã‰tat Actuel du Projet

### Statut de DÃ©veloppement
- âœ… **Application fonctionnelle** en production
- âœ… **Backend sÃ©curisÃ©** sans vulnÃ©rabilitÃ©s connues
- âœ… **Documentation complÃ¨te** et Ã  jour
- âš ï¸ **DÃ©pendances frontend** : vulnÃ©rabilitÃ©s mineures identifiÃ©es

### Architecture ValidÃ©e
- âœ… **SÃ©paration frontend/backend** claire
- âœ… **API REST** complÃ¨te et documentÃ©e
- âœ… **Base de donnÃ©es** multi-environnement
- âœ… **Authentification JWT** robuste
- âœ… **Interface responsive** validÃ©e

## Points d'Attention

### SÃ©curitÃ©
- ğŸ”’ **Authentification** : JWT avec middleware obligatoire
- ğŸ”’ **Validation** : cÃ´tÃ© client ET serveur
- ğŸ”’ **Base de donnÃ©es** : requÃªtes prÃ©parÃ©es exclusivement
- ğŸ”’ **CORS** : configuration stricte

### Maintenance
- ğŸ“‹ **DÃ©pendances** : audit rÃ©gulier recommandÃ© (voir dependency-audit-2025-09-19.md)
- ğŸ“‹ **Configuration** : variables d'environnement via fichiers .env
- ğŸ“‹ **Migrations** : automatiques au dÃ©marrage
- ğŸ“‹ **Documentation** : maintien Ã  jour obligatoire
- ğŸ“‹ **Versioning** : commit aprÃ¨s chaque modification significative

### Performance
- âš¡ **Frontend** : optimisation React (memoization, lazy loading)
- âš¡ **Backend** : requÃªtes SQL optimisÃ©es
- âš¡ **Base de donnÃ©es** : index appropriÃ©s

